# 0x5f3759df what the fuck?

## 史上最牛3D图形运算底层代码（神秘的0x5f3759df）～～

大家玩过DOS时代游戏的都知道，就以当初CPU的计算能力，能有QuakeIII这样的3D游戏真是惊为天人。

而3D图像运算最常用到的就是开方运算。是3D矢量运算的基础。又涉及浮点运算会消耗大量CPU资源。

随着QuakeIII 3D引擎的保密期到期代码开源，终于有机会一窥约翰-卡马克（John Carmack）大神的大作。

其中的底层代码有一个求平方根倒数的c函数竟然比官方指令集sqrt（）再求倒快四倍


```js
float Q_rsqrt( float number )
{
	long i;
	float x2, y;
	const float threehalfs = 1.5F;
 
	x2 = number * 0.5F;
	y  = number;
	i  = * ( long * ) &y;                       // evil floating point bit level hacking
	i  = 0x5f3759df - ( i >> 1 );               // what the fuck?
	y  = * ( float * ) &i;
	y  = y * ( threehalfs - ( x2 * y * y ) );   // 1st iteration
//  y  = y * ( threehalfs - ( x2 * y * y ) );   // 2nd iteration, this can be removed
 
	return y;
}
```

注意到这个函数只用了一次叠代，第二次迭代直接被注释掉了。其实就是直接运算，因此非常高效。为什么要用迭代见文后介绍（大学高等数学内容～～）

这个函数最核心的语句就是标注了“what the fuck?”的一句 
i = 0x5f3759df - ( i >> 1 ); 

注意此句为定点移位运算，速度极快！特别在很多没有乘法指令的RISC结构CPU上，这样做是极其高效的。


而这个神秘的常数0x5f3759df 是什么？


就是个极致优化的猜测值
这个够简单粗暴吧，而且效果很好～～


## 附：牛顿迭代法快速寻找平方根

下面这种方法可以很有效地求出根号a的近似值：首先随便猜一个近似值x，然后不断令x等于x和a/x的平均数，迭代个六七次后x的值就已经相当精确了。
例如，我想求根号2等于多少。假如我猜测的结果为4，虽然错的离谱，但你可以看到使用牛顿迭代法后这个值很快就趋近于根号2了：

```
( 4 + 2/ 4 ) / 2 = 2.25
( 2.25 + 2/ 2.25 ) / 2 = 1.56944..
( 1.56944..+ 2/1.56944..) / 2 = 1.42189..
( 1.42189..+ 2/1.42189..) / 2 = 1.41423.. 
....
```
